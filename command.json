{
    "name": "centiloid-pet-quantification",
    "label": "Centiloid PET Quantification",
    "description": "Quantify amyloid burden in PET scans using Centiloid methodology. Converts DICOM to NIfTI, registers to template space, and calculates SUVR/Centiloid values with QC outputs.",
    "version": "1.1.6",
    "schema-version": "1.0",
    "image": "xnatworks/xnat_centiloid_container:v1.1.6",
    "type": "docker",
    "command-line": "python -m app.pipeline --dicom-dir /input --template #TEMPLATE# --target-mask #TARGET_MASK# --ref-mask #REF_MASK# --tracer #TRACER# --mode #MODE# --out-dir /output --reg-mode #REG_MODE# --xnat-host $XNAT_HOST --xnat-user $XNAT_USER --xnat-pass $XNAT_PASS --xnat-project #PROJECT# --xnat-session #SESSION_ID#",
    "override-entrypoint": true,
    "mounts": [
        {
            "name": "input",
            "writable": false,
            "path": "/input"
        },
        {
            "name": "output",
            "writable": true,
            "path": "/output"
        }
    ],
    "environment-variables": {},
    "ports": {},
    "inputs": [
        {
            "name": "template",
            "description": "Template NIfTI file that defines the coordinate space of the masks (e.g., MNI space)",
            "type": "string",
            "required": false,
            "replacement-key": "#TEMPLATE#",
            "default-value": "/maskdata/template_space.nii.gz"
        },
        {
            "name": "target-mask",
            "description": "Target (cortical) mask in template space for SUVR calculation",
            "type": "string",
            "required": false,
            "replacement-key": "#TARGET_MASK#",
            "default-value": "/maskdata/centiloid_ctx_mask.nii.gz"
        },
        {
            "name": "ref-mask", 
            "description": "Reference (cerebellar) mask in template space for SUVR calculation",
            "type": "string",
            "required": false,
            "replacement-key": "#REF_MASK#",
            "default-value": "/maskdata/whole_cerebellum_mask.nii.gz"
        },
        {
            "name": "tracer",
            "description": "PET tracer used for Centiloid calibration",
            "type": "string",
            "required": true,
            "replacement-key": "#TRACER#",
            "default-value": "FBP"
        },
        {
            "name": "mode",
            "description": "Processing mode for tracer type",
            "type": "string",
            "required": true,
            "replacement-key": "#MODE#",
            "default-value": "amyloid"
        },
        {
            "name": "reg-mode",
            "description": "Registration mode for PET to template alignment",
            "type": "string",
            "required": true,
            "replacement-key": "#REG_MODE#",
            "default-value": "rigid"
        },
        {
            "name": "session_id",
            "description": "XNAT session ID",
            "type": "string",
            "required": true,
            "replacement-key": "#SESSION_ID#"
        },
        {
            "name": "project",
            "description": "XNAT project ID", 
            "type": "string",
            "required": true,
            "replacement-key": "#PROJECT#"
        }
    ],
    "outputs": [
        {
            "name": "centiloid-json",
            "description": "Complete quantification results in JSON format",
            "required": true,
            "mount": "output",
            "path": "centiloid.json",
            "glob": null
        },
        {
            "name": "centiloid-csv", 
            "description": "Summary metrics in CSV format",
            "required": true,
            "mount": "output",
            "path": "centiloid.csv",
            "glob": null
        },
        {
            "name": "qc-overlay",
            "description": "Quality control visualization with mask overlays",
            "required": true,
            "mount": "output", 
            "path": "qc_overlay.png",
            "glob": null
        },
        {
            "name": "converted-nifti",
            "description": "PET data converted from DICOM to NIfTI",
            "required": false,
            "mount": "output",
            "path": "dcm2niix",
            "glob": null
        },
        {
            "name": "registration-outputs",
            "description": "Registered PET image and transformation parameters",
            "required": true,
            "mount": "output",
            "path": "registration",
            "glob": null
        },
        {
            "name": "dicom-series",
            "description": "DICOM series with parametric map, overlays, and QC reports",
            "required": true,
            "mount": "output",
            "path": "dicom_series",
            "glob": null
        }
    ],
    "xnat": [
        {
            "name": "centiloud-pet-scan",
            "label": "Centiloud PET Quantification",
            "description": "Process PET scan for amyloid quantification using Centiloud methodology",
            "contexts": ["xnat:petScanData"],
            "external-inputs": [
                {
                    "name": "scan",
                    "description": "Input PET scan",
                    "type": "Scan",
                    "required": true,
                    "provides-files-for-command-mount": "input",
                    "load-children": false
                },
                {
                    "name": "tracer",
                    "description": "PET tracer type",
                    "type": "string",
                    "required": true,
                    "user-settable": true,
                    "default-value": "FBP",
                    "provides-value-for-command-input": "tracer"
                },
                {
                    "name": "mode",
                    "description": "Processing mode",
                    "type": "string", 
                    "required": true,
                    "user-settable": true,
                    "default-value": "amyloid",
                    "provides-value-for-command-input": "mode"
                },
                {
                    "name": "reg-mode",
                    "description": "Registration mode",
                    "type": "string",
                    "required": true,
                    "user-settable": true,
                    "default-value": "rigid",
                    "provides-value-for-command-input": "reg-mode"
                }
            ],
            "derived-inputs": [
                {
                    "name": "session-id",
                    "description": "The session's id", 
                    "type": "string",
                    "required": true,
                    "provides-value-for-command-input": "session_id",
                    "load-children": true,
                    "derived-from-wrapper-input": "scan",
                    "derived-from-xnat-object-property": "session-id",
                    "multiple": false
                },
                {
                    "name": "project-id",
                    "description": "The project",
                    "type": "string", 
                    "required": true,
                    "provides-value-for-command-input": "project",
                    "load-children": true,
                    "derived-from-wrapper-input": "scan",
                    "derived-from-xnat-object-property": "project-id",
                    "multiple": false
                }
            ],
            "output-handlers": [
                {
                    "name": "centiloud-results",
                    "accepts-command-output": "centiloid-json",
                    "as-a-child-of": "scan",
                    "type": "Resource",
                    "label": "centiloud-results"
                },
                {
                    "name": "centiloud-csv-results",
                    "accepts-command-output": "centiloid-csv", 
                    "as-a-child-of": "scan",
                    "type": "Resource",
                    "label": "centiloud-csv-results"
                },
                {
                    "name": "qc-visualization",
                    "accepts-command-output": "qc-overlay",
                    "as-a-child-of": "scan", 
                    "type": "Resource",
                    "label": "qc-visualization"
                },
                {
                    "name": "nifti-conversion",
                    "accepts-command-output": "converted-nifti",
                    "as-a-child-of": "scan",
                    "type": "Resource", 
                    "label": "nifti-conversion"
                },
                {
                    "name": "registration-files",
                    "accepts-command-output": "registration-outputs",
                    "as-a-child-of": "scan",
                    "type": "Resource",
                    "label": "registration-files" 
                },
                {
                    "name": "dicom-results",
                    "accepts-command-output": "dicom-series",
                    "as-a-child-of": "scan",
                    "type": "Resource",
                    "label": "dicom-results"
                }
            ]
        }
    ]
}